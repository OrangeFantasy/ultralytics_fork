### SOPHGO export:

#### Concat 输出节点不参与 INT8 量化，但直接导出模型会产生错误：
![](sophgo_error.png)

1. 导出模型、标定表和量化表

2. 复制模型、标定表和量化表到 tpu-mlir docker 目录下生成 bmodel

```shell
cp -r /data4/yuanchengzhi/projects/yolo/MultiTaskDetector/runs/_export/v8s_student_qat_relu6_sophgo/weights/sophgo /data4/yuanchengzhi/projects/.pkgs/tpu-mlir/models
```

3. 转换模型，生成 .mlir
```shell
mkdir workspace && cd workspace

model_transform.py \
    --model_name sophgo \
    --model_def ../sophgo_deploy_model.onnx \
    --input_shapes [[1,3,448,768]] \
    --keep_aspect_ratio \
    --pixel_format rgb \
    --mlir sophgo.mlir
```
4. 根据 .mlir 中的节点名称，修改量化表，标记非量化节点为 F16

```shell
Other_Quantization_Nodes INT8
head_96_Concat F16
head_48_Concat F16
head_24_Concat F16
body_96_Concat F16
body_48_Concat F16
body_24_Concat F16
raise_hand_96_Concat F16
raise_hand_48_Concat F16
raise_hand_24_Concat F16
stand_up_96_Concat F16
stand_up_48_Concat F16
stand_up_24_Concat F16
face_96_Concat F16
face_48_Concat F16
face_24_Concat F16
```
```shell
Other_Quantization_Nodes INT8
box_cls_kpt_angle_96_Concat F16
box_cls_kpt_angle_48_Concat F16
box_cls_kpt_angle_24_Concat F16
```

6. 生成 .bmodel

model_deploy.py \
    --mlir sophgo.mlir --model_version 1.0 \
    --quantize INT8 \
    --processor bm1684x \
    --calibration_table ../sophgo_cali_table_from_sophgo_mq_sophgo_tpu \
    --quantize_table ../sophgo_q_table_from_sophgo_mq_sophgo_tpu \
    --model v8s_student_bm1684x_int8.bmodel

model_deploy.py \
    --mlir sophgo.mlir --model_version 1.0 \
    --quantize INT8 \
    --processor bm1684x \
    --calibration_table ../sophgo_cali_table_from_sophgo_mq_sophgo_tpu \
    --quantize_table ../sophgo_q_table_from_sophgo_mq_sophgo_tpu \
    --model v8s_teacher_bm1684x_int8.bmodel
```

